<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Camera Glitch</title>
  <style>
    :root{--bg:#050608;--fg:#d9ffe2;--neon:#39ff88;--muted:#7ccf9a;--border:#1b2a22}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui}
    header{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:center;justify-content:space-between}
    header b{color:var(--neon);letter-spacing:.6px}
    main{max-width:1100px;margin:0 auto;padding:12px;display:grid;gap:12px}
    .panel{border:1px solid var(--border);border-radius:14px;overflow:hidden;background:#070b0c}
    .wrap{position:relative;width:100%;aspect-ratio:16/9;background:#000}
    canvas{width:100%;height:100%;display:block}
    .overlay{
      pointer-events:none; position:absolute; inset:0;
      background: repeating-linear-gradient(to bottom, rgba(255,255,255,.06) 0px, rgba(255,255,255,.06) 1px, transparent 2px, transparent 4px);
      mix-blend-mode: overlay; opacity:.35;
    }
    .controls{padding:12px;display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    button{
      border:1px solid var(--border); background:#08110d; color:var(--fg);
      padding:10px 12px; border-radius:12px; cursor:pointer;
    }
    button.primary{border-color:rgba(57,255,136,.45);background:rgba(57,255,136,.12)}
    button.danger{border-color:rgba(255,80,80,.35);background:rgba(255,80,80,.10)}
    button:disabled{opacity:.5;cursor:not-allowed}
    .slider{min-width:220px;display:flex;flex-direction:column;gap:6px}
    .slider label{font-size:12px;color:var(--muted)}
    input[type=range]{width:100%;accent-color:var(--neon)}
    .note{padding:0 12px 12px;color:var(--muted);font-size:12px}
    a{color:var(--neon)}
  </style>
</head>
<body>
<header>
  <div><b>Camera Glitch</b> <span style="color:#7ccf9a;font-size:12px">runs locally in your browser</span></div>
  <a href="./index.html" style="color:#39ff88;text-decoration:none">‚Üê back</a>
</header>

<main>
  <section class="panel">
    <div class="wrap">
      <canvas id="c"></canvas>
      <div class="overlay"></div>
    </div>

    <div class="controls">
      <button id="start" class="primary">üì∑ Start</button>
      <button id="stop" class="danger" disabled>‚õî Stop</button>
      <button id="switch" disabled>üîÅ Switch</button>
      <button id="toggle" class="primary">‚ö° Glitch: ON</button>
      <button id="freeze">üßä Freeze</button>

      <div class="slider">
        <label>Intensity: <span id="ival">0.55</span></label>
        <input id="intensity" type="range" min="0" max="1" step="0.01" value="0.55">
      </div>

      <div class="slider">
        <label>FPS: <span id="fval">30</span></label>
        <input id="fps" type="range" min="5" max="60" step="1" value="30">
      </div>
    </div>

    <div class="note">
      Camera turns on only after you click Start and allow permission. This page does not upload video anywhere.
      (GitHub Pages is HTTPS so camera works.)
    </div>
  </section>
</main>

<script>
(() => {
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d', { willReadFrequently: true });

  const startBtn = document.getElementById('start');
  const stopBtn = document.getElementById('stop');
  const switchBtn = document.getElementById('switch');
  const toggleBtn = document.getElementById('toggle');
  const freezeBtn = document.getElementById('freeze');

  const intensity = document.getElementById('intensity');
  const fps = document.getElementById('fps');
  const ival = document.getElementById('ival');
  const fval = document.getElementById('fval');

  const video = document.createElement('video');
  video.playsInline = true;
  video.muted = true;
  video.autoplay = true;

  let stream = null;
  let facingMode = 'environment';
  let glitchOn = true;
  let frozen = false;

  let lastFrame = 0;
  let t = 0;

  function fit(w, h){
    const maxW = 1280;
    const scale = Math.min(1, maxW / w);
    canvas.width = Math.round(w * scale);
    canvas.height = Math.round(h * scale);
  }

  function glitchPass(img, amt){
    const { width:w, height:h, data } = img;

    // scanlines + noise
    const noiseAmt = 18 * amt;
    const scanAmt = 0.18 * amt;

    for (let y=0; y<h; y++){
      const scan = (y % 3 === 0) ? (1 - scanAmt) : 1;
      for (let x=0; x<w; x++){
        const i = (y*w + x)*4;
        const n = (Math.random() - 0.5) * noiseAmt;
        data[i]   = Math.max(0, Math.min(255, (data[i]   + n) * scan));
        data[i+1] = Math.max(0, Math.min(255, (data[i+1] + n) * scan));
        data[i+2] = Math.max(0, Math.min(255, (data[i+2] + n) * scan));
      }
    }

    // horizontal slice shifts
    const slices = Math.floor(6 + amt * 22);
    for (let s=0; s<slices; s++){
      const y = Math.floor(Math.random() * h);
      const sliceH = Math.max(1, Math.floor((Math.random() * 18 + 2) * amt));
      const dx = Math.floor((Math.random() - 0.5) * w * 0.25 * amt);

      for (let yy=y; yy<Math.min(h, y+sliceH); yy++){
        const rowStart = yy*w*4;
        const row = data.slice(rowStart, rowStart + w*4);
        for (let x=0; x<w; x++){
          const srcX = (x - dx + w) % w;
          const di = rowStart + x*4;
          const si = srcX*4;
          data[di]   = row[si];
          data[di+1] = row[si+1];
          data[di+2] = row[si+2];
        }
      }
    }

    // RGB split drift
    const split = Math.floor(1 + amt * 10);
    const copy = data.slice();
    const drift = Math.sin(t) * 2 * amt;

    const sample = (src, x, y, c) => {
      x = (x + w) % w; y = (y + h) % h;
      return src[(y*w + x)*4 + c];
    };

    for (let y=0; y<h; y++){
      for (let x=0; x<w; x++){
        const i = (y*w + x)*4;
        data[i]   = sample(copy, x + split + drift, y, 0);
        data[i+1] = sample(copy, x - split - drift, y, 1);
        data[i+2] = sample(copy, x + split*2, y, 2);
      }
    }

    return img;
  }

  async function startCamera(){
    await stopCamera();
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode }, audio:false });
    video.srcObject = stream;
    await video.play();

    fit(video.videoWidth || 1280, video.videoHeight || 720);

    stopBtn.disabled = false;
    switchBtn.disabled = false;
  }

  async function stopCamera(){
    if (stream){
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    video.srcObject = null;
    stopBtn.disabled = true;
    switchBtn.disabled = true;
  }

  startBtn.addEventListener('click', async () => {
    try { await startCamera(); }
    catch(e){ alert("Camera blocked. This needs HTTPS or localhost."); console.error(e); }
  });

  stopBtn.addEventListener('click', async () => { await stopCamera(); });

  switchBtn.addEventListener('click', async () => {
    facingMode = (facingMode === 'environment') ? 'user' : 'environment';
    try { await startCamera(); } catch(e){ console.error(e); }
  });

  toggleBtn.addEventListener('click', () => {
    glitchOn = !glitchOn;
    toggleBtn.textContent = glitchOn ? "‚ö° Glitch: ON" : "‚ö° Glitch: OFF";
    toggleBtn.classList.toggle('primary', glitchOn);
  });

  freezeBtn.addEventListener('click', () => {
    frozen = !frozen;
    freezeBtn.textContent = frozen ? "‚ñ∂ Unfreeze" : "üßä Freeze";
  });

  intensity.addEventListener('input', () => ival.textContent = Number(intensity.value).toFixed(2));
  fps.addEventListener('input', () => fval.textContent = fps.value);

  // init size
  canvas.width = 1280; canvas.height = 720;

  function loop(now){
    const target = 1000 / Number(fps.value);
    if (!lastFrame) lastFrame = now;
    const elapsed = now - lastFrame;

    if (elapsed >= target){
      lastFrame = now - (elapsed % target);

      if (!frozen){
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        if (glitchOn && stream){
          const img = ctx.getImageData(0,0,canvas.width,canvas.height);
          ctx.putImageData(glitchPass(img, Number(intensity.value)), 0, 0);
        }
        t += 0.016;
      }
    }
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>